class Level extends Phaser.Scene{constructor(){super("Level"),this.gameOptions={tileSize:200,tweenSpeed:50,tileSpacing:20},this.children=[],this.tileNumber=window.gameOpt.score,this.time=0,this.score=0,this.gameOver=!1,this.directions=["left","right","up","down"]}editorCreate(){const e=this.add.text(823,70,"",{});e.setOrigin(.5,.5),e.text="0",e.setStyle({align:"center",fontFamily:"neodgm",fontSize:"40px"});const i=this.add.text(180,70,"",{});i.setOrigin(.5,.5),i.text="Time :",i.setStyle({align:"center",fontFamily:"neodgm",fontSize:"40px"}),this.scoreTxt=e,this.timeTxt=i,this.events.emit("scene-awake")}scoreTxt;timeTxt;preload(){this.load.scenePlugin({key:"rexgesturesplugin",url:"https://raw.githubusercontent.com/rexrainbow/phaser3-rex-notes/master/dist/rexgesturesplugin.min.js",sceneKey:"rexGestures"})}create(){this.editorCreate(),this.add.image(0,0,"bg").setOrigin(0,0),this.scoreTxt.setDepth(1),this.timeTxt.setDepth(1),this.fieldArray=[],this.fieldGroup=this.add.group();for(var e=0;e<4;e++){this.fieldArray[e]=[];for(var i=0;i<4;i++){var t=this.add.sprite(this.tileDestination(i),this.tileDestination(e),"tiles");t.alpha=0,t.visible=0,this.fieldGroup.add(t),this.fieldArray[e][i]={tileValue:0,tileSprite:t,canUpgrade:!0}}}this.children=this.fieldGroup.getChildren(),this.input.keyboard.on("keydown",this.handleKey,this),this.canMove=!1,this.addTwo(),this.addTwo(),this.container=this.add.container(),this.container.add(this.children),this.container.setPosition("",370),this.swipeInput=this.rexGestures.add.swipe({velocityThreshold:1e3}).on("swipe",(function(e){print.text+=`swipe, v = ${e.dragVelocity}\n`}),this)}update(e,i){if(!this.gameOver){if(this.swipeInput.isSwiped){const e=this.dumpDirectionStates(this.swipeInput);"left"==e?this.canMove&&this.moveLeft():"right"==e?this.canMove&&this.moveRight():"up"==e?this.canMove&&this.moveUp():"down"==e&&this.canMove&&this.moveDown()}this.time=Math.round(.001*e),this.timeTxt.setText(`Time : ${new Date(1e3*this.time).toISOString().slice(14,19)}`)}}dumpDirectionStates(e){for(var i,t="",s=0,r=this.directions.length;s<r;s++)e[i=this.directions[s]]&&(t+=i);return t}addTwo(){for(var e=[],i=0;i<4;i++)for(var t=0;t<4;t++)0==this.fieldArray[i][t].tileValue&&e.push({row:i,col:t});var s=Phaser.Utils.Array.GetRandom(e);this.fieldArray[s.row][s.col].tileValue=1,this.fieldArray[s.row][s.col].tileSprite.visible=!0,this.fieldArray[s.row][s.col].tileSprite.setFrame(0),this.tweens.add({targets:[this.fieldArray[s.row][s.col].tileSprite],alpha:1,duration:this.gameOptions.tweenSpeed,onComplete:function(e){e.parent.scene.canMove=!0,e.parent.scene.checkGameOver()}})}moveLeft(){for(var e=0;e<this.children.length;e++)this.children[e].depth=this.children[e].x;this.handleMove(0,-1)}moveRight(){for(var e=0;e<this.children.length;e++)this.children[e].depth=this.game.config.width-this.children[e].x;this.handleMove(0,1)}moveUp(){for(var e=0;e<this.children.length;e++)this.children[e].depth=this.children[e].y;this.handleMove(-1,0)}moveDown(){for(var e=0;e<this.children.length;e++)this.children[e].depth=this.game.config.height-this.children[e].y;this.handleMove(1,0)}handleKey(e){if(this.canMove)switch(e.code){case"ArrowLeft":this.moveLeft();break;case"ArrowRight":this.moveRight();break;case"ArrowUp":this.moveUp();break;case"ArrowDown":this.moveDown()}}handleMove(e,i){this.canMove=!1;var t=!1;this.movingTiles=0;for(var s=0;s<4;s++)for(var r=0;r<4;r++){var a=1==i?3-r:r,n=1==e?3-s:s,h=this.fieldArray[n][a].tileValue;if(0!=h){for(var l=i,o=e;this.isInsideBoard(n+o,a+l)&&0==this.fieldArray[n+o][a+l].tileValue;)l+=i,o+=e;this.isInsideBoard(n+o,a+l)&&this.fieldArray[n+o][a+l].tileValue==h&&this.fieldArray[n+o][a+l].canUpgrade&&this.fieldArray[n][a].canUpgrade?(this.fieldArray[n+o][a+l].tileValue++,this.fieldArray[n+o][a+l].canUpgrade=!1,this.fieldArray[n][a].tileValue=0,this.moveTile(this.fieldArray[n][a],n+o,a+l,Math.abs(o+l),!0),t=!0):(o-=e,0==(l-=i)&&0==o||(this.fieldArray[n+o][a+l].tileValue=h,this.fieldArray[n][a].tileValue=0,this.moveTile(this.fieldArray[n][a],n+o,a+l,Math.abs(o+l),!1),t=!0))}}t||(this.canMove=!0)}moveTile(e,i,t,s,r){this.movingTiles++,this.tweens.add({targets:[e.tileSprite],x:this.tileDestination(t),y:this.tileDestination(i),duration:this.gameOptions.tweenSpeed*s,onComplete:function(s){s.parent.scene.movingTiles--,r&&s.parent.scene.transformTile(e,i,t),0==s.parent.scene.movingTiles&&(s.parent.scene.resetTiles(),s.parent.scene.addTwo())}})}transformTile(e,i,t){this.movingTiles++;const s=this.fieldArray[i][t].tileValue-1;e.tileSprite.setFrame(s),this.scoreTxt.setText(` ${this.score+=parseInt(this.tileNumber[s])}`),this.tweens.add({targets:[e.tileSprite],scaleX:1.1,scaleY:1.1,duration:this.gameOptions.tweenSpeed,yoyo:!0,repeat:1,onComplete:function(e){e.parent.scene.movingTiles--,0==e.parent.scene.movingTiles&&(e.parent.scene.resetTiles(),e.parent.scene.addTwo())}})}resetTiles(){for(var e=0;e<4;e++)for(var i=0;i<4;i++)this.fieldArray[e][i].canUpgrade=!0,this.fieldArray[e][i].tileSprite.x=this.tileDestination(i),this.fieldArray[e][i].tileSprite.y=this.tileDestination(e),this.fieldArray[e][i].tileValue>0?(this.fieldArray[e][i].tileSprite.alpha=1,this.fieldArray[e][i].tileSprite.visible=!0,this.fieldArray[e][i].tileSprite.setFrame(this.fieldArray[e][i].tileValue-1)):(this.fieldArray[e][i].tileSprite.alpha=0,this.fieldArray[e][i].tileSprite.visible=!1)}isInsideBoard(e,i){return e>=0&&i>=0&&e<4&&i<4}tileDestination(e){return 50+e*(this.gameOptions.tileSize+this.gameOptions.tileSpacing)+this.gameOptions.tileSize/2+this.gameOptions.tileSpacing}checkGameOver(){for(var e=0;e<4;e++)for(var i=0;i<4;i++){if(0==this.fieldArray[e][i].tileValue)return;if(e<3&&this.fieldArray[e][i].tileValue==this.fieldArray[e+1][i].tileValue)return;if(i<3&&this.fieldArray[e][i].tileValue==this.fieldArray[e][i+1].tileValue)return}alert("Gmae Over!"),this.gameOver=!0,$.ajax({url:`${window.apiUrl}/api/puzzle`,data:{serialNum:window.serialNum,score:this.score,playTime:this.time,publishedDate:new Date},dataType:"json",method:"post",success:function(e){console.log(e)},error:function(e,i,t){302==e.status?console.log(`[API UPDATE] => ${e.responseText}`):console.error(`[API ERROR] => ${e.responseText}`)}})}}